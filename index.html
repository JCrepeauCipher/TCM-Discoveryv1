<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCM Discovery Guide</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for checkboxes to match the chunky look */
        .custom-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        /* Hide scrollbar for cleaner look if needed */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .group:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Print Styles */
        @media print {
            @page {
                margin: 0.5cm;
            }
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                padding-bottom: 0;
                background-color: white; 
            }
            /* Hide all buttons during print (Reset, Save PDF, Copy CRM) */
            button, #confirmation-modal { 
                display: none !important; 
            }
            /* Unstick headers so they don't float over content */
            header, .sticky { 
                position: static !important; 
            }
            /* Remove shadows for cleaner print */
            .shadow-md, .shadow-sm, .shadow-lg {
                box-shadow: none !important;
            }
            /* Ensure textareas print their content clearly */
            textarea {
                border: 1px solid #e2e8f0;
                resize: none;
                overflow: visible;
                display: block;
            }
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800 pb-20">

    <!-- 1. Top Header -->
    <header class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center shadow-md sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center font-bold text-lg shadow-sm">
                CH
            </div>
            <div>
                <h1 class="text-xl font-bold leading-none">TCM Discovery Guide</h1>
                <p class="text-slate-400 text-xs mt-1 uppercase tracking-wider">Transitional Care Management Qualification</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="requestReset()" class="flex items-center gap-2 text-slate-400 hover:text-white text-sm font-medium transition-colors">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Reset
            </button>
            <button onclick="window.print()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded font-bold text-sm flex items-center gap-2 shadow-sm transition-colors">
                <i data-lucide="file-text" class="w-4 h-4"></i> Save to PDF
            </button>
        </div>
    </header>

    <!-- 2. Live Sales Coach Bar -->
    <div class="bg-blue-50 border-b border-blue-100 px-6 py-4 sticky top-[72px] z-40 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-start gap-4">
            <div class="bg-white p-2 rounded-full shadow-sm border border-blue-100 text-blue-600">
                <i data-lucide="bot" class="w-7 h-7"></i>
            </div>
            <div>
                <div class="text-blue-600 text-[10px] font-bold uppercase tracking-widest mb-0.5">Live Sales Coach</div>
                <h2 id="coach-title" class="text-lg font-bold text-slate-800 leading-tight">Listening for signals...</h2>
                <p id="coach-text" class="text-slate-500 text-sm mt-0.5">Select Green or Red flags below to get real-time positioning advice.</p>
            </div>
        </div>

        <!-- Deal Health Indicator -->
        <div class="flex flex-col items-end">
            <div class="flex items-center gap-1.5 mb-1 relative group">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Deal Health</span>
                <i data-lucide="info" class="w-3.5 h-3.5 text-slate-400 cursor-help hover:text-blue-500 transition-colors"></i>
                
                <!-- Tooltip -->
                <div class="tooltip absolute right-0 top-6 w-56 bg-slate-800 text-white text-xs p-4 rounded shadow-xl z-50 border border-slate-700">
                    <div class="absolute -top-1 right-1 w-2 h-2 bg-slate-800 rotate-45 border-t border-l border-slate-700"></div>
                    <p class="font-bold mb-2 border-b border-slate-700 pb-1 text-slate-200">Algorithm Logic</p>
                    <ul class="space-y-2 text-slate-300">
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 mt-1 shrink-0"></span>
                            <span><b>Good:</b> Green flags lead by 2+</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 rounded-full bg-rose-500 mt-1 shrink-0"></span>
                            <span><b>Bad:</b> Red flags lead by 2+</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 rounded-full bg-amber-400 mt-1 shrink-0"></span>
                            <span><b>Neutral:</b> Gap is less than 2</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="flex gap-1.5">
                <div id="health-bad" class="w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300"></div>
                <div id="health-neutral" class="w-3 h-3 rounded-full bg-amber-400 transition-colors duration-300"></div>
                <div id="health-good" class="w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300"></div>
            </div>
        </div>
    </div>

    <main class="max-w-5xl mx-auto p-6 space-y-6">
        
        <!-- 3. Prospect Details -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Prospect Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Hospital Name</label>
                    <input type="text" id="hospital-name" class="w-full bg-slate-50 border border-slate-200 rounded p-3 text-slate-700 focus:outline-none focus:border-blue-400 transition-colors" placeholder="e.g. Memorial Health">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Stakeholders</label>
                    <input type="text" id="stakeholders" class="w-full bg-slate-50 border border-slate-200 rounded p-3 text-slate-700 focus:outline-none focus:border-blue-400 transition-colors" placeholder="e.g. Jane Doe (CFO)">
                </div>
            </div>
        </div>

        <!-- 4. Questions Container (Populated by JS) -->
        <div id="questions-container" class="space-y-6"></div>

        <!-- Footer -->
        <div class="flex justify-center pt-8">
            <button id="btn-copy-crm" onclick="copyForCRM()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 transition-all">
                <i data-lucide="clipboard-copy" class="w-5 h-5"></i> Copy for CRM
            </button>
        </div>

    </main>

    <!-- Custom Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4 backdrop-blur-sm transition-all duration-200">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full border border-slate-200 transform scale-100">
            <div class="flex items-center gap-3 mb-2 text-slate-800">
                <div class="bg-red-100 p-2 rounded-full text-red-600">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                </div>
                <h3 class="text-lg font-bold">Reset Form?</h3>
            </div>
            <p class="text-slate-600 mb-6 ml-11 text-sm">This will clear all your selections and notes. This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded text-sm font-medium transition-colors">Cancel</button>
                <button onclick="executeReset()" class="px-4 py-2 bg-red-600 text-white rounded text-sm font-bold hover:bg-red-700 shadow-sm transition-colors">Yes, Reset</button>
            </div>
        </div>
    </div>

    <script>
        // Data Structure
        const questionsData = [
            {
                id: 1,
                category: "STAFFING",
                text: "Who on your team is physically making the outreach calls?",
                subtext: "Uncover staff burnout and high labor costs.",
                positiveSignals: [
                    { id: 'q1_p1', label: "\"Centralized call center team.\"" },
                    { id: 'q1_p2', label: "\"Medical Assistants or Admin staff.\"" },
                ],
                negativeSignals: [
                    { id: 'q1_n1', label: "\"Our RNs / Nurse Manager does it.\"", tip: "ROI: RNs are too expensive for phone tag. Highlight burnout." },
                    { id: 'q1_n2', label: "\"Front desk tries when they can.\"", tip: "Inefficiency: Distracted staff leads to low contact rates." },
                ]
            },
            {
                id: 2,
                category: "EFFICIENCY",
                text: "On average, how many outbound attempts does it take to actually reach a patient?",
                subtext: "Highlight the manual labor of 'phone tag'.",
                positiveSignals: [
                    { id: 'q2_p1', label: "\"1-2 attempts usually.\"" },
                    { id: 'q2_p2', label: "\"We text them first.\"" },
                ],
                negativeSignals: [
                    { id: 'q2_n1', label: "\"3 to 5 attempts.\"", tip: "Labor Cost: Calculate mins/patient. 5 calls * 5 mins = 25 mins lost." },
                    { id: 'q2_n2', label: "\"We leave voicemails (doesn't count).\"", tip: "Compliance: Voicemail is NOT interactive contact. Claim will be denied." },
                ]
            },
            {
                id: 3,
                category: "COMPLIANCE",
                text: "How do you currently handle the 2-day contact requirement for patients discharged on a Friday?",
                subtext: "Identify if they miss the 48-hour window on weekends.",
                positiveSignals: [
                    { id: 'q3_p1', label: "\"We have weekend staff calling.\"" },
                    { id: 'q3_p2', label: "\"We use an automated outreach tool.\"" },
                ],
                negativeSignals: [
                    { id: 'q3_n1', label: "\"We scramble on Monday mornings.\"", tip: "Risky: Monday is often Day 3. Ask about denials." },
                    { id: 'q3_n2', label: "\"We just don't bill Friday discharges.\"", tip: "Revenue Leak: Compute the loss (approx 20% of volume)." },
                    { id: 'q3_n3', label: "\"What 2-day requirement?\"", tip: "Education Gap: Explain CPT 99496 requirements immediately." },
                ]
            },
            {
                id: 4,
                category: "SCHEDULING",
                text: "When you reach a patient, how often are you unable to get them on the calendar within the 7 or 14-day window?",
                subtext: "Identify revenue leakage due to operational friction.",
                positiveSignals: [
                    { id: 'q4_p1', label: "\"We have dedicated TCM slots.\"" },
                    { id: 'q4_p2', label: "\"We use Telehealth for these visits.\"" },
                ],
                negativeSignals: [
                    { id: 'q4_n1', label: "\"Doctors are booked 3 weeks out.\"", tip: "Deal Breaker: If they can't see them, they can't bill. Can we offer Telehealth?" },
                    { id: 'q4_n2', label: "\"We squeeze them in, but it's hard.\"", tip: "Pain: This stresses the clinic. Propose automated scheduling." },
                ]
            },
            {
                id: 5,
                category: "RISK",
                text: "Are you documenting the Med Rec during the phone call, or waiting until the visit?",
                subtext: "Compliance trap: Med Rec must be done on/before visit.",
                positiveSignals: [
                    { id: 'q5_p1', label: "\"Done during the initial call.\"" },
                ],
                negativeSignals: [
                    { id: 'q5_n1', label: "\"We do it when they come in.\"", tip: "Compliance: If patient no-shows, the call isn't billable. Move Med Rec upstream." },
                    { id: 'q5_n2', label: "\"Doctor does it during the exam.\"", tip: "Inefficiency: Slows down the provider. RN should prep this." },
                ]
            },
            {
                id: 6,
                category: "FINANCIAL",
                text: "Based on your monthly discharge volume, do you know the gap between potential vs. actual TCM revenue?",
                subtext: "Strategic ROI question.",
                positiveSignals: [
                    { id: 'q6_p1', label: "\"Yes, we track capture rate closely.\"" },
                ],
                negativeSignals: [
                    { id: 'q6_n1', label: "\"We don't track that specifically.\"", tip: "Close: Use the Calculator above to show them the number now." },
                    { id: 'q6_n2', label: "\"We think we get most of them.\"", tip: "Doubt: 'Most' usually means 30%. Challenge gently." },
                ]
            }
        ];

        // Render Questions on Load
        function renderApp() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            questionsData.forEach(q => {
                const html = `
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                    <!-- Header -->
                    <div class="p-6 border-b border-slate-100">
                        <span class="inline-block bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded mb-3">
                            Q${q.id}: ${q.category}
                        </span>
                        <h2 class="text-xl font-bold text-slate-900 mb-2 font-serif">"${q.text}"</h2>
                        <p class="text-slate-400 text-sm italic">Goal: ${q.subtext}</p>
                    </div>

                    <!-- Grid -->
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Red Flags -->
                        <div>
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="flag" class="text-rose-600 w-5 h-5"></i>
                                <h4 class="font-bold text-rose-700">Red Flags (Risks)</h4>
                            </div>
                            <div class="space-y-3">
                                ${q.negativeSignals.map(sig => `
                                    <label class="flex items-start gap-3 p-3 rounded cursor-pointer border border-slate-100 hover:border-rose-200 bg-slate-50 transition-all has-[:checked]:bg-rose-50 has-[:checked]:border-rose-200">
                                        <input type="checkbox" onchange="calculateHealth(this)" class="signal-checkbox custom-checkbox mt-1 w-4 h-4 rounded text-rose-600 focus:ring-rose-500 border-gray-300" data-type="negative" data-qid="${q.id}" data-tip="${sig.tip || ''}">
                                        <span class="text-sm text-slate-600 font-medium has-[:checked]:text-rose-900">${sig.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Listen For (Green) -->
                        <div>
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="ear" class="text-emerald-600 w-5 h-5"></i>
                                <h4 class="font-bold text-emerald-700">Green Flags (Good)</h4>
                            </div>
                            <div class="space-y-3">
                                ${q.positiveSignals.map(sig => `
                                    <label class="flex items-start gap-3 p-3 rounded cursor-pointer border border-slate-100 hover:border-emerald-200 bg-slate-50 transition-all has-[:checked]:bg-emerald-50 has-[:checked]:border-emerald-200">
                                        <input type="checkbox" onchange="calculateHealth(this)" class="signal-checkbox custom-checkbox mt-1 w-4 h-4 rounded text-emerald-600 focus:ring-emerald-500 border-gray-300" data-type="positive" data-qid="${q.id}" data-tip="">
                                        <span class="text-sm text-slate-600 font-medium has-[:checked]:text-emerald-900">${sig.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="px-6 pb-6 pt-2">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Rep Notes</h4>
                        <textarea id="note-q${q.id}" class="w-full min-h-[80px] p-3 rounded border border-slate-200 bg-white text-slate-700 focus:outline-none focus:border-blue-400 text-sm resize-y" placeholder="Notes..."></textarea>
                    </div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });

            // Initialize Icons
            lucide.createIcons();
        }

        // Deal Health Algorithm & Coach Logic
        function calculateHealth(triggerCheckbox = null) {
            const checkboxes = document.querySelectorAll('.signal-checkbox:checked');
            let posCount = 0;
            let negCount = 0;

            checkboxes.forEach(cb => {
                if (cb.dataset.type === 'positive') posCount++;
                if (cb.dataset.type === 'negative') negCount++;
            });

            // Determine Health State
            let health = 'neutral';
            if (posCount > negCount + 1) health = 'good';
            if (negCount > posCount + 1) health = 'bad';

            updateUI(health, posCount, negCount, triggerCheckbox);
            return health;
        }

        // Update UI based on Health & Triggers
        function updateUI(health, posCount, negCount, triggerCheckbox) {
            const titleEl = document.getElementById('coach-title');
            const textEl = document.getElementById('coach-text');
            const badDot = document.getElementById('health-bad');
            const neutralDot = document.getElementById('health-neutral');
            const goodDot = document.getElementById('health-good');

            // Reset Dots
            badDot.className = "w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300";
            neutralDot.className = "w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300";
            goodDot.className = "w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300";

            // 1. Prioritize specific tip from the checkbox just clicked
            if (triggerCheckbox && triggerCheckbox.checked && triggerCheckbox.dataset.tip) {
                titleEl.textContent = "Coach Advice:";
                textEl.textContent = triggerCheckbox.dataset.tip;
                
                // Keep the color logic for the dots below
            } 
            // 2. Fallback to general health state if no specific tip triggered or box unchecked
            else {
                if (posCount === 0 && negCount === 0) {
                    titleEl.textContent = "Listening for signals...";
                    textEl.textContent = "Select Green or Red flags below to get real-time positioning advice.";
                    neutralDot.classList.remove('bg-slate-300');
                    neutralDot.classList.add('bg-amber-400');
                    return;
                } else if (health === 'bad') {
                    titleEl.textContent = "High Pain Detected";
                    textEl.textContent = "Multiple Red Flags. Focus on the cost of doing nothing (Compliance Risk + Lost Revenue).";
                } else if (health === 'good') {
                    titleEl.textContent = "Strong Qualification";
                    textEl.textContent = "They have good processes. Focus on 'Optimization' rather than 'Fixing broken things'.";
                } else {
                    titleEl.textContent = "Analyzing Pattern...";
                    textEl.textContent = "Mixed signals. Dig deeper into the Red flags to see if they are urgent problems.";
                }
            }

            // Update Dots Visuals
            if (health === 'bad') {
                badDot.classList.remove('bg-slate-300');
                badDot.classList.add('bg-rose-500');
            } else if (health === 'good') {
                goodDot.classList.remove('bg-slate-300');
                goodDot.classList.add('bg-emerald-500');
            } else {
                neutralDot.classList.remove('bg-slate-300');
                neutralDot.classList.add('bg-amber-400');
            }
        }

        // CRM Copy Function
        function copyForCRM() {
            const hospital = document.getElementById('hospital-name').value || "N/A";
            const stakeholders = document.getElementById('stakeholders').value || "N/A";
            const currentHealth = calculateHealth().toUpperCase();

            // Build the text note
            let text = `TCM DISCOVERY SUMMARY\n`;
            text += `==================================\n`;
            text += `PROSPECT: ${hospital}\n`;
            text += `STAKEHOLDERS: ${stakeholders}\n`;
            text += `DEAL HEALTH: ${currentHealth}\n`;
            text += `==================================\n\n`;

            questionsData.forEach(q => {
                const qId = q.id;
                const checkedSignals = Array.from(document.querySelectorAll(`.signal-checkbox[data-qid="${qId}"]:checked`));
                const note = document.getElementById(`note-q${qId}`).value.trim();

                // Only add sections that have data
                if (checkedSignals.length > 0 || note) {
                    text += `[${q.category}] ${q.text}\n`;
                    
                    if (checkedSignals.length > 0) {
                        checkedSignals.forEach(cb => {
                            const type = cb.dataset.type === 'positive' ? '(+)' : '(-)';
                            const labelText = cb.nextElementSibling.innerText;
                            text += `  â€¢ ${type} ${labelText}\n`;
                        });
                    }
                    
                    if (note) {
                        text += `  > NOTE: ${note}\n`;
                    }
                    text += `\n`;
                }
            });

            // Use legacy execCommand for maximum iframe compatibility
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                
                // Visual Feedback
                const btn = document.getElementById('btn-copy-crm');
                const originalContent = btn.innerHTML;
                
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                btn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> Copied!`;
                lucide.createIcons();

                setTimeout(() => {
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                    btn.innerHTML = originalContent;
                    lucide.createIcons();
                }, 2000);

            } catch (err) {
                console.error('Copy failed', err);
                const btn = document.getElementById('btn-copy-crm');
                const originalContent = btn.innerHTML;
                
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.innerHTML = `<i data-lucide="x" class="w-5 h-5"></i> Error Copying`;
                lucide.createIcons();
                
                setTimeout(() => {
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.innerHTML = originalContent;
                    lucide.createIcons();
                }, 2000);
            }
            
            document.body.removeChild(textArea);
        }

        // Custom Modal Logic to replace native confirm()
        function requestReset() {
            const modal = document.getElementById('confirmation-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('confirmation-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function executeReset() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
            document.querySelectorAll('textarea').forEach(txt => txt.value = '');
            
            calculateHealth(); // Reset UI
            closeModal();
        }
        
        // Auto-expand textareas before printing
        window.addEventListener('beforeprint', () => {
            document.querySelectorAll('textarea').forEach(tx => {
                tx.style.height = 'auto';
                tx.style.height = tx.scrollHeight + 'px';
            });
        });

        // Run on start
        renderApp();
    </script>
</body>
</html>