<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCM Discovery Guide</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for checkboxes to match the chunky look */
        .custom-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        /* Hide scrollbar for cleaner look if needed */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .group:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Print Styles */
        @media print {
            @page {
                margin: 0.5cm;
            }
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                padding-bottom: 0;
                background-color: white; 
            }
            /* Hide all buttons during print (Reset, Save PDF, Copy CRM) */
            button { 
                display: none !important; 
            }
            /* Unstick headers so they don't float over content */
            header, .sticky { 
                position: static !important; 
            }
            /* Remove shadows for cleaner print */
            .shadow-md, .shadow-sm, .shadow-lg {
                box-shadow: none !important;
            }
            /* Ensure textareas print their content clearly */
            textarea {
                border: 1px solid #e2e8f0;
                resize: none;
                overflow: visible;
                display: block;
            }
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800 pb-20">

    <!-- 1. Top Header -->
    <header class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center shadow-md sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center font-bold text-lg shadow-sm">
                CH
            </div>
            <div>
                <h1 class="text-xl font-bold leading-none">TCM Discovery Guide</h1>
                <p class="text-slate-400 text-xs mt-1 uppercase tracking-wider">Transitional Care Management Qualification</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="resetForm()" class="flex items-center gap-2 text-slate-400 hover:text-white text-sm font-medium transition-colors">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Reset
            </button>
            <button onclick="window.print()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded font-bold text-sm flex items-center gap-2 shadow-sm transition-colors">
                <i data-lucide="file-text" class="w-4 h-4"></i> Save to PDF
            </button>
        </div>
    </header>

    <!-- 2. Live Sales Coach Bar -->
    <div class="bg-blue-50 border-b border-blue-100 px-6 py-4 sticky top-[72px] z-40 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-start gap-4">
            <div class="bg-white p-2 rounded-full shadow-sm border border-blue-100 text-blue-600">
                <i data-lucide="bot" class="w-7 h-7"></i>
            </div>
            <div>
                <div class="text-blue-600 text-[10px] font-bold uppercase tracking-widest mb-0.5">Live Sales Coach</div>
                <h2 id="coach-title" class="text-lg font-bold text-slate-800 leading-tight">Listening for signals...</h2>
                <p id="coach-text" class="text-slate-500 text-sm mt-0.5">Select Green or Red flags below to get real-time positioning advice.</p>
            </div>
        </div>

        <!-- Deal Health Indicator -->
        <div class="flex flex-col items-end">
            <div class="flex items-center gap-1.5 mb-1 relative group">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Deal Health</span>
                <i data-lucide="info" class="w-3.5 h-3.5 text-slate-400 cursor-help hover:text-blue-500 transition-colors"></i>
                
                <!-- Tooltip -->
                <div class="tooltip absolute right-0 top-6 w-56 bg-slate-800 text-white text-xs p-4 rounded shadow-xl z-50 border border-slate-700">
                    <div class="absolute -top-1 right-1 w-2 h-2 bg-slate-800 rotate-45 border-t border-l border-slate-700"></div>
                    <p class="font-bold mb-2 border-b border-slate-700 pb-1 text-slate-200">Algorithm Logic</p>
                    <ul class="space-y-2 text-slate-300">
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500 mt-1 shrink-0"></span>
                            <span><b>Good:</b> Green flags lead by 2+</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 rounded-full bg-rose-500 mt-1 shrink-0"></span>
                            <span><b>Bad:</b> Red flags lead by 2+</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 rounded-full bg-amber-400 mt-1 shrink-0"></span>
                            <span><b>Neutral:</b> Gap is less than 2</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="flex gap-1.5">
                <div id="health-bad" class="w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300"></div>
                <div id="health-neutral" class="w-3 h-3 rounded-full bg-amber-400 transition-colors duration-300"></div>
                <div id="health-good" class="w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300"></div>
            </div>
        </div>
    </div>

    <main class="max-w-5xl mx-auto p-6 space-y-6">
        
        <!-- 3. Prospect Details Card -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Prospect Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Health System / Hospital Name</label>
                    <input type="text" id="hospital-name" class="w-full bg-slate-50 border border-slate-200 rounded p-3 text-slate-700 focus:outline-none focus:border-blue-400 transition-colors" placeholder="e.g. Memorial Health">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Stakeholders Present</label>
                    <input type="text" id="stakeholders" class="w-full bg-slate-50 border border-slate-200 rounded p-3 text-slate-700 focus:outline-none focus:border-blue-400 transition-colors" placeholder="e.g. Jane Doe (CFO), Dr. Smith (CMO)">
                </div>
            </div>
        </div>

        <!-- 4. Questions Container (Populated by JS) -->
        <div id="questions-container" class="space-y-6"></div>

        <!-- Footer -->
        <div class="flex justify-center pt-8">
            <button id="btn-copy-crm" onclick="copyForCRM()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 transition-all">
                <i data-lucide="clipboard-copy" class="w-5 h-5"></i> Copy for CRM
            </button>
        </div>

    </main>

    <script>
        // Data Structure
        const questionsData = [
            {
                id: 1,
                category: "PERFORMANCE",
                text: "How are you currently tracking your TCM capture rate?",
                subtext: "Identify if they know they are losing money.",
                positiveSignals: [
                    { id: 'q1_p1', label: "\"Concerned about readmissions / patients 'falling off the cliff'.\"" },
                    { id: 'q1_p2', label: "\"We track it manually on spreadsheets.\"" },
                    { id: 'q1_p3', label: "\"We know our rate is low (under 40%).\"" },
                    { id: 'q1_p4', label: "\"CFO is pushing for new revenue streams.\"" },
                ],
                negativeSignals: [
                    { id: 'q1_n1', label: "\"We don't bill for TCM / Not a priority.\"" },
                    { id: 'q1_n2', label: "\"Our EHR already does this perfectly.\"" },
                    { id: 'q1_n3', label: "\"We have no budget for new tools.\"" },
                ]
            },
            {
                id: 2,
                category: "WORKFLOW",
                text: "Walk me through the process. Who makes the calls?",
                subtext: "Identify staff burnout and inefficiency.",
                positiveSignals: [
                    { id: 'q2_p1', label: "\"Nurses are doing it on top of clinical work.\"" },
                    { id: 'q2_p2', label: "\"We miss weekend discharges (2-day window).\"" },
                    { id: 'q2_p3', label: "\"It takes 20 mins just to find the patient phone number.\"" },
                ],
                negativeSignals: [
                    { id: 'q2_n1', label: "\"We outsource this to a call center firm.\"" },
                    { id: 'q2_n2', label: "\"We only call high-risk patients (intentional).\"" },
                ]
            },
            {
                id: 3,
                category: "CHALLENGES",
                text: "What happens when you miss a patient?",
                subtext: "Uncover pain points and urgency.",
                positiveSignals: [
                    { id: 'q3_p1', label: "\"We lose the revenue (approx $200/patient).\"" },
                    { id: 'q3_p2', label: "\"Readmission penalties increase.\"" },
                ],
                negativeSignals: [
                    { id: 'q3_n1', label: "\"It's fine, we have plenty of volume.\"" },
                    { id: 'q3_n2', label: "\"Administration doesn't care about this metric.\"" },
                ]
            }
        ];

        // Render Questions on Load
        function renderApp() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            questionsData.forEach(q => {
                const html = `
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                    <!-- Header -->
                    <div class="p-6 border-b border-slate-100">
                        <span class="inline-block bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded mb-3">
                            Q${q.id}: ${q.category}
                        </span>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2 font-serif">"${q.text}"</h2>
                        <p class="text-slate-400 text-sm italic">Goal: ${q.subtext}</p>
                    </div>

                    <!-- Grid -->
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Listen For (Green) -->
                        <div>
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="ear" class="text-emerald-600 w-5 h-5"></i>
                                <h4 class="font-bold text-emerald-700">Listen For (Green Flags)</h4>
                            </div>
                            <div class="space-y-3">
                                ${q.positiveSignals.map(sig => `
                                    <label class="flex items-start gap-3 p-3 rounded cursor-pointer border border-slate-100 hover:border-emerald-200 bg-slate-50 transition-all has-[:checked]:bg-emerald-50 has-[:checked]:border-emerald-200">
                                        <input type="checkbox" onchange="calculateHealth()" class="signal-checkbox custom-checkbox mt-1 w-4 h-4 rounded text-emerald-600 focus:ring-emerald-500 border-gray-300" data-type="positive" data-qid="${q.id}" data-sid="${sig.id}">
                                        <span class="text-sm text-slate-600 font-medium has-[:checked]:text-emerald-900">${sig.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Red Flags -->
                        <div>
                            <div class="flex items-center gap-2 mb-4">
                                <i data-lucide="flag" class="text-rose-600 w-5 h-5"></i>
                                <h4 class="font-bold text-rose-700">Red Flags (Risks)</h4>
                            </div>
                            <div class="space-y-3">
                                ${q.negativeSignals.map(sig => `
                                    <label class="flex items-start gap-3 p-3 rounded cursor-pointer border border-slate-100 hover:border-rose-200 bg-slate-50 transition-all has-[:checked]:bg-rose-50 has-[:checked]:border-rose-200">
                                        <input type="checkbox" onchange="calculateHealth()" class="signal-checkbox custom-checkbox mt-1 w-4 h-4 rounded text-rose-600 focus:ring-rose-500 border-gray-300" data-type="negative" data-qid="${q.id}" data-sid="${sig.id}">
                                        <span class="text-sm text-slate-600 font-medium has-[:checked]:text-rose-900">${sig.label}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="px-6 pb-6 pt-2">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Rep Notes</h4>
                        <textarea id="note-q${q.id}" class="w-full min-h-[80px] p-3 rounded border border-slate-200 bg-white text-slate-700 focus:outline-none focus:border-blue-400 text-sm resize-y" placeholder="Type specific metrics mentioned (e.g. 300 discharges/mo)..."></textarea>
                    </div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });

            // Initialize Icons
            lucide.createIcons();
        }

        // Deal Health Algorithm
        function calculateHealth() {
            const checkboxes = document.querySelectorAll('.signal-checkbox:checked');
            let posCount = 0;
            let negCount = 0;

            checkboxes.forEach(cb => {
                if (cb.dataset.type === 'positive') posCount++;
                if (cb.dataset.type === 'negative') negCount++;
            });

            // Determine Health
            let health = 'neutral';
            if (posCount > negCount + 1) health = 'good';
            if (negCount > posCount + 1) health = 'bad';

            updateUI(health, posCount, negCount);
            return health;
        }

        // Update UI based on Health
        function updateUI(health, posCount, negCount) {
            const titleEl = document.getElementById('coach-title');
            const textEl = document.getElementById('coach-text');
            const badDot = document.getElementById('health-bad');
            const neutralDot = document.getElementById('health-neutral');
            const goodDot = document.getElementById('health-good');

            // Reset Dots
            badDot.className = "w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300";
            neutralDot.className = "w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300";
            goodDot.className = "w-3 h-3 rounded-full bg-slate-300 transition-colors duration-300";

            if (posCount === 0 && negCount === 0) {
                titleEl.textContent = "Listening for signals...";
                textEl.textContent = "Select Green or Red flags below to get real-time positioning advice.";
                neutralDot.classList.remove('bg-slate-300');
                neutralDot.classList.add('bg-amber-400');
                return;
            }

            if (health === 'bad') {
                titleEl.textContent = "Caution: High Resistance";
                textEl.textContent = "Red flags detected. They seem efficient or uninterested. Pivot to: \"Even with that process, do you ever miss patients?\"";
                badDot.classList.remove('bg-slate-300');
                badDot.classList.add('bg-rose-500');
            } else if (health === 'good') {
                titleEl.textContent = "Strong Opportunity Detected";
                textEl.textContent = "Great signals. They have admitted to pain. Dig deeper: \"How does that impact your annual revenue?\"";
                goodDot.classList.remove('bg-slate-300');
                goodDot.classList.add('bg-emerald-500');
            } else {
                titleEl.textContent = "Analyzing Pattern...";
                textEl.textContent = "Mixed signals received. Clarify the red flags to see if they are hard stops.";
                neutralDot.classList.remove('bg-slate-300');
                neutralDot.classList.add('bg-amber-400');
            }
        }

        // CRM Copy Function
        function copyForCRM() {
            const hospital = document.getElementById('hospital-name').value || "N/A";
            const stakeholders = document.getElementById('stakeholders').value || "N/A";
            const currentHealth = calculateHealth().toUpperCase();

            // Build the text note
            let text = `TCM DISCOVERY SUMMARY\n`;
            text += `==================================\n`;
            text += `PROSPECT: ${hospital}\n`;
            text += `STAKEHOLDERS: ${stakeholders}\n`;
            text += `DEAL HEALTH: ${currentHealth}\n`;
            text += `==================================\n\n`;

            questionsData.forEach(q => {
                const qId = q.id;
                const checkedSignals = Array.from(document.querySelectorAll(`.signal-checkbox[data-qid="${qId}"]:checked`));
                const note = document.getElementById(`note-q${qId}`).value.trim();

                // Only add sections that have data
                if (checkedSignals.length > 0 || note) {
                    text += `[Q${qId}: ${q.category}] ${q.text}\n`;
                    
                    if (checkedSignals.length > 0) {
                        checkedSignals.forEach(cb => {
                            const type = cb.dataset.type === 'positive' ? '(+)' : '(-)';
                            const labelText = cb.nextElementSibling.innerText;
                            text += `  â€¢ ${type} ${labelText}\n`;
                        });
                    }
                    
                    if (note) {
                        text += `  > NOTE: ${note}\n`;
                    }
                    text += `\n`;
                }
            });

            // Use legacy execCommand for maximum iframe compatibility
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                
                // Visual Feedback
                const btn = document.getElementById('btn-copy-crm');
                const originalContent = btn.innerHTML;
                
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                btn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> Copied!`;
                lucide.createIcons();

                setTimeout(() => {
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                    btn.innerHTML = originalContent;
                    lucide.createIcons();
                }, 2000);

            } catch (err) {
                console.error('Copy failed', err);
                alert("Failed to copy notes. Please manually copy the content.");
            }
            
            document.body.removeChild(textArea);
        }

        function resetForm() {
            if (confirm("Clear all selections and notes?")) {
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
                document.querySelectorAll('textarea').forEach(txt => txt.value = '');
                calculateHealth(); // Reset UI
            }
        }
        
        // Auto-expand textareas before printing to prevent cut-off text
        window.addEventListener('beforeprint', () => {
            document.querySelectorAll('textarea').forEach(tx => {
                tx.style.height = 'auto';
                tx.style.height = tx.scrollHeight + 'px';
            });
        });

        // Run on start
        renderApp();
    </script>
</body>
</html>